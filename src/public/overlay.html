<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Overlay LiveChat</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
                background: transparent;
                font-family: Arial, sans-serif;
            }

            #content-container {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 85vw;
                max-height: 85vh;
                display: none;
                z-index: 1000;
            }

            #content-container.fullscreen {
                max-width: 100vw;
                max-height: 100vh;
                width: 100vw;
                height: 100vh;
                top: 0;
                left: 0;
                transform: none;
            }

            #content-container.fullscreen img,
            #content-container.fullscreen video {
                width: 100%;
                height: 100%;
                object-fit: contain;
                border-radius: 0;
            }

            .user-avatar {
                position: fixed;
                bottom: 20px;
                left: 20px;
                width: 62px;
                height: 62px;
                border-radius: 50%;
                border: 4px solid rgb(89, 255, 47);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                z-index: 1001;
                display: none;
                opacity: 0;
                transition: opacity 0.1s ease;
            }

            .user-avatar.fade-in {
                opacity: 1;
            }

            .user-avatar.fade-out {
                opacity: 0;
            }

            .user-avatar img {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
            }

            #content-container img,
            #content-container video {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                opacity: 0;
                transition: opacity 0.1s ease;
            }

            #content-container img.fade-in,
            #content-container video.fade-in {
                opacity: 1;
            }

            #content-container img.fade-out,
            #content-container video.fade-out {
                opacity: 0;
            }

            #content-container audio {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }

            .fade-in {
                animation: fadeIn 0.5s ease-in forwards;
            }

            .fade-out {
                animation: fadeOut 0.5s ease-out forwards;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: scale(1);
                }
                to {
                    opacity: 0;
                    transform: scale(0.95);
                }
            }

            #connection-status {
                position: fixed;
                bottom: 10px;
                right: 10px;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 500;
                color: white;
                display: none;
                z-index: 1001;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                transition: opacity 0.5s ease;
                opacity: 0;
            }

            #connection-status.fade-in {
                opacity: 1;
            }

            #connection-status.fade-out {
                opacity: 0;
            }

            .connected {
                background-color: #4caf50;
            }

            .disconnected {
                background-color: #f44336;
            }

            .loader {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 50px;
                height: 50px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                z-index: 1002;
            }

            @keyframes spin {
                0% {
                    transform: translate(-50%, -50%) rotate(0deg);
                }
                100% {
                    transform: translate(-50%, -50%) rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div id="content-container"></div>
        <div id="connection-status"></div>
        <div class="loader"></div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            const CONFIG = {
                RECONNECT_ATTEMPTS: 60 * 60 * 1000 /* 1 hour */,
                RECONNECT_DELAY: 30 * 1000 /* 30 seconds */,
                DISPLAY_DURATION: 5 * 1000 /* 5 seconds */,
                FADE_DURATION: 500 /* 500 milliseconds */,
                SUPPORTED_VIDEO_FORMATS: /\.(mp4|webm|mkv|mov)$/i,
                SUPPORTED_AUDIO_FORMATS: /\.(mp3|wav|ogg)$/i,
            };

            const elements = {
                contentContainer: document.getElementById('content-container'),
                connectionStatus: document.getElementById('connection-status'),
                loader: document.querySelector('.loader'),
            };

            let socket = null;
            let currentContent = null;
            let currentTimeout = null;
            let contentQueue = [];
            let isProcessingQueue = false;
            let statusTimeout = null;
            let isDisconnected = false;

            function init() {
                const SERVER_URL =
                    window.location.hostname === 'localhost'
                        ? 'http://localhost:3000'
                        : `https://${window.location.hostname}`;

                setupSocket(SERVER_URL);
            }

            function setupSocket(serverUrl) {
                socket = io(serverUrl, {
                    reconnection: true,
                    reconnectionAttempts: CONFIG.RECONNECT_ATTEMPTS,
                    reconnectionDelay: CONFIG.RECONNECT_DELAY,
                });

                socket.on('connect', handleConnect);
                socket.on('disconnect', handleDisconnect);
                socket.on('connect_error', handleConnectError);
                socket.on('newContent', handleNewContent);
            }

            function handleConnect() {
                updateConnectionStatus(true);

                const username = new URLSearchParams(window.location.search).get('username');
                const guildId = new URLSearchParams(window.location.search).get('guildId');

                if (!username) {
                    updateConnectionStatus(false, 'Erreur de configuration: ?username param missing');
                    return;
                }

                if (!guildId) {
                    updateConnectionStatus(false, 'Erreur de configuration: ?guildId param missing');
                    return;
                }

                socket.emit('register', { username, guildId });
            }

            function handleDisconnect() {
                updateConnectionStatus(false);
            }

            function handleConnectError(error) {
                console.error('Erreur de connexion:', error);
                updateConnectionStatus(false, 'Serveur injoignable');
            }

            function handleNewContent({ content, from, fullscreen }) {
                console.log('Nouveau livechat reÃ§u:', content, 'de:', from.username);

                contentQueue.push({ content, from, fullscreen });

                if (!isProcessingQueue) {
                    processNextContent();
                }
            }

            function processNextContent() {
                if (contentQueue.length === 0) {
                    isProcessingQueue = false;
                    return;
                }

                isProcessingQueue = true;
                const { content, from, fullscreen } = contentQueue.shift();

                cleanupCurrentContent(() => {
                    const element = createContentElement(content, from, fullscreen);
                    if (element) {
                        displayContent(element, fullscreen);
                    }
                });
            }

            function cleanupCurrentContent(callback) {
                if (currentTimeout) {
                    clearTimeout(currentTimeout);
                    currentTimeout = null;
                }

                if (currentContent) {
                    currentContent.classList.add('fade-out');
                    setTimeout(() => {
                        if (elements.contentContainer.contains(currentContent)) {
                            elements.contentContainer.removeChild(currentContent);
                        }
                        if (callback) callback();
                    }, CONFIG.FADE_DURATION);
                } else {
                    if (callback) callback();
                }
            }

            function createContentElement(content, from, fullscreen) {
                try {
                    const url = new URL(content);
                    const filename = url.pathname.split('/').pop() || '';
                    const isVideo = CONFIG.SUPPORTED_VIDEO_FORMATS.test(filename);
                    const isAudio = CONFIG.SUPPORTED_AUDIO_FORMATS.test(filename);

                    let avatarElement = document.querySelector('.user-avatar');
                    if (!avatarElement) {
                        avatarElement = document.createElement('div');
                        avatarElement.className = 'user-avatar';
                        document.body.appendChild(avatarElement);
                    }

                    const avatarImg = document.createElement('img');
                    avatarImg.src = from.avatarURL;
                    avatarElement.innerHTML = '';
                    avatarElement.appendChild(avatarImg);
                    avatarElement.style.display = fullscreen ? 'none' : 'block';
                    void avatarElement.offsetWidth;
                    avatarElement.classList.add('fade-in');

                    const element = document.createElement(isVideo ? 'video' : isAudio ? 'audio' : 'img');
                    element.src = content;

                    if (isVideo || isAudio) {
                        element.controls = true;
                        element.autoplay = true;
                        element.muted = false;
                        element.playsInline = true;

                        element.onerror = handleMediaError;
                        element.onloadeddata = () => {
                            void element.offsetWidth;
                            element.classList.add('fade-in');
                            element.play().catch(console.error);
                        };
                        element.addEventListener('ended', () => {
                            element.classList.add('fade-out');
                            const avatarElement = document.querySelector('.user-avatar');
                            if (avatarElement) {
                                avatarElement.classList.add('fade-out');
                            }
                            setTimeout(() => {
                                removeContent(element, () => {
                                    processNextContent();
                                });
                            }, 100);
                        });
                    } else {
                        void element.offsetWidth;
                        element.classList.add('fade-in');

                        currentTimeout = setTimeout(() => {
                            element.classList.add('fade-out');
                            const avatarElement = document.querySelector('.user-avatar');
                            if (avatarElement) {
                                avatarElement.classList.add('fade-out');
                            }
                            setTimeout(() => {
                                removeContent(element, () => {
                                    processNextContent();
                                });
                            }, 100);
                        }, CONFIG.DISPLAY_DURATION);
                    }

                    return element;
                } catch (error) {
                    console.error("Erreur lors de l'affichage du livechat\n", error);
                    return null;
                }
            }

            function displayContent(element, fullscreen) {
                elements.contentContainer.appendChild(element);
                currentContent = element;
                elements.contentContainer.style.display = 'block';
                if (fullscreen) {
                    elements.contentContainer.classList.add('fullscreen');
                } else {
                    elements.contentContainer.classList.remove('fullscreen');
                }
            }

            function removeContent(element, callback) {
                if (elements.contentContainer.contains(element)) {
                    elements.contentContainer.removeChild(element);
                    elements.contentContainer.style.display = 'none';
                    elements.contentContainer.classList.remove('fullscreen');
                    currentContent = null;
                }

                const avatarElement = document.querySelector('.user-avatar');
                if (avatarElement) {
                    avatarElement.style.display = 'none';
                }

                if (callback) callback();
            }

            function handleMediaError(error) {
                console.error('Erreur de chargement du mÃ©dia\n', error);
                processNextContent();
            }

            function updateConnectionStatus(connected, message = '') {
                if (statusTimeout) {
                    clearTimeout(statusTimeout);
                }

                if (isDisconnected && !connected) {
                    return;
                }

                elements.connectionStatus.style.display = 'block';
                elements.connectionStatus.classList.remove('fade-out');
                elements.connectionStatus.className = connected ? 'connected' : 'disconnected';
                elements.connectionStatus.textContent = connected
                    ? 'ConnectÃ© au Live Chat'
                    : `DÃ©connectÃ© du Live Chat${message ? `: ${message}` : ''}`;

                void elements.connectionStatus.offsetWidth;

                elements.connectionStatus.classList.add('fade-in');

                statusTimeout = setTimeout(() => {
                    elements.connectionStatus.classList.remove('fade-in');
                    elements.connectionStatus.classList.add('fade-out');
                    setTimeout(() => {
                        elements.connectionStatus.style.display = 'none';
                    }, 500);
                }, 5000);

                isDisconnected = !connected;
            }

            init();
        </script>
    </body>
</html>
